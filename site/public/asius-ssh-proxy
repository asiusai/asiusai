#!/bin/bash
# asius-ssh-proxy - SSH proxy for Asius devices
# Usage: asius-ssh-proxy <dongle_id>
#
# Install:
#   curl -fsSL https://asius.ai/asius-ssh-proxy -o asius-ssh-proxy
#   chmod +x asius-ssh-proxy
#   sudo mv asius-ssh-proxy /usr/local/bin/
#
# Requires:
#   - websocat (https://github.com/vi/websocat)
#   - ASIUS_TOKEN environment variable set to your JWT token
#
# SSH config (~/.ssh/config):
#   Host asius-*
#     User comma
#     ProxyCommand asius-ssh-proxy %n
#     StrictHostKeyChecking no
#     UserKnownHostsFile /dev/null

set -e

# Extract dongle_id from hostname (asius-XXXXX -> XXXXX)
if [[ "$1" == asius-* ]]; then
  DONGLE_ID="${1#asius-}"
else
  DONGLE_ID="$1"
fi

API_URL="${ASIUS_API_URL:-https://api.asius.ai}"
TOKEN="${ASIUS_TOKEN}"

if [ -z "$DONGLE_ID" ]; then
  echo "Usage: asius-ssh-proxy <dongle_id>" >&2
  echo "       asius-ssh-proxy asius-<dongle_id>" >&2
  exit 1
fi

if [ -z "$TOKEN" ]; then
  echo "Error: ASIUS_TOKEN environment variable not set" >&2
  echo "Get your token from https://connect.asius.ai" >&2
  exit 1
fi

# Check for websocat
if ! command -v websocat &> /dev/null; then
  echo "Error: websocat is required but not installed" >&2
  echo "Install: brew install websocat (macOS) or download from github.com/vi/websocat" >&2
  exit 1
fi

# Create SSH session via API
RESPONSE=$(curl -s -X POST "$API_URL/v1/devices/$DONGLE_ID/ssh" \
  -H "Authorization: JWT $TOKEN" \
  -H "Content-Type: application/json")

# Parse response for wsUrl
WS_URL=$(echo "$RESPONSE" | grep -o '"wsUrl":"[^"]*"' | cut -d'"' -f4)

if [ -z "$WS_URL" ]; then
  # Check for error message
  ERROR=$(echo "$RESPONSE" | grep -o '"error":"[^"]*"' | cut -d'"' -f4)
  if [ -n "$ERROR" ]; then
    echo "Error: $ERROR" >&2
  else
    echo "Error: Failed to create SSH session" >&2
    echo "Response: $RESPONSE" >&2
  fi
  exit 1
fi

# Connect to WebSocket relay (binary mode for SSH traffic)
exec websocat -b "$WS_URL" --header "Authorization: JWT $TOKEN"
